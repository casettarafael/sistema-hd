<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#10b981">
    <title>HD System PRO - Modo Flex</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <link rel="stylesheet" href="style.css">

    <style>
        /* --- ESTILOS ORIGINAIS --- */
        .pagination-footer { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: var(--bg-card); border-top: 1px solid var(--border); border-radius: 0 0 8px 8px; margin-top: -1px; }
        .btn-page { background: var(--primary); color: #fff; border: none; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; transition: opacity 0.2s; }
        .btn-page:disabled { opacity: 0.5; cursor: not-allowed; background: var(--gray); }
        .btn-page:hover:not(:disabled) { filter: brightness(1.1); }
        #info-paginacao, #info-pag-dash { font-weight: 600; color: var(--text); font-size: 0.9rem; }

        .login-container { max-width: 350px !important; text-align: center; }
        .login-logo { margin-bottom: 20px; color: var(--primary); font-size: 3rem; }

        .zap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; }
        .btn-zap-opt { background: var(--bg); border: 1px solid var(--border); padding: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; color: var(--text); display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 0.9rem; }
        .btn-zap-opt:hover { background: #e0f2f1; border-color: #10b981; color: #10b981; transform: translateY(-2px); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-zap-opt i { font-size: 1.5rem; margin-bottom: 5px; }

        /* --- NOVOS ESTILOS (ESTRAT√âGIA FLEX) --- */
        
        /* Anima√ß√£o para o bot√£o de oferta pulsar */
        @keyframes pulse-red {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        #btn-flex-disparo {
            background-color: #ef4444; /* Vermelho alerta ou use var(--accent) */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse-red 2s infinite;
            margin-right: 15px;
            transition: all 0.3s ease;
        }

        #btn-flex-disparo:hover { transform: scale(1.05); }

        #btn-excluir-massa {
            background-color: #374151; /* Cinza escuro para diferenciar do bot√£o de oferta */
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-right: 10px;
            transition: all 0.3s ease;
        }
        #btn-excluir-massa:hover { background-color: #1f2937; transform: scale(1.05); }
        
        /* Classe utilit√°ria para esconder elementos */
        .hidden-force { display: none !important; }

        /* Estilo do Checkbox na tabela */
        .check-cliente {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        /* Agrupamento dos bot√µes do topo */
        .header-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Bot√£o de excluir na linha da tabela */
        .btn-delete-row {
            background: #fee2e2;
            color: #ef4444;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            margin-left: 5px;
            transition: 0.2s;
        }
        .btn-delete-row:hover { background: #ef4444; color: white; }
    </style>
</head>
<body>

    <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="logo">
            <h2>HD System</h2>
            <button class="btn-close-sidebar" onclick="toggleSidebar()"><i class="fas fa-times"></i></button>
        </div>
        
        <nav class="menu-nav">
            <a href="#" id="link-dashboard" class="menu-item active" onclick="navegar('dashboard')">
                <i class="fas fa-chart-pie"></i> Dashboard
            </a>
            <a href="#" id="link-leads" class="menu-item" onclick="navegar('leads')">
                <i class="fas fa-bell"></i> Solicita√ß√µes Site
                <span id="badge-leads" class="badge hidden">0</span>
            </a>
            <a href="#" id="link-vendas" class="menu-item" onclick="navegar('vendas')">
                <i class="fas fa-plus-circle"></i> Novo Servi√ßo
            </a>
            <a href="#" id="link-clientes" class="menu-item" onclick="navegar('clientes')">
                <i class="fas fa-address-book"></i> Clientes
            </a>
            <a href="#" id="link-financeiro" class="menu-item" onclick="navegar('financeiro')">
                <i class="fas fa-file-invoice-dollar"></i> Recibos
            </a>
        </nav>

        <div class="theme-switch-wrapper">
            <label class="theme-switch" for="checkbox">
                <input type="checkbox" id="checkbox" />
                <div class="slider round"></div>
            </label>
            <em>Modo Escuro</em>
        </div>

        <div class="user-info">
            <p><strong>HD Aquecedores</strong></p>
            <div class="actions">
                <button onclick="exportarCSV()" class="btn-link"><i class="fas fa-download"></i> Backup Excel</button>
                <button onclick="fazerLogout()" class="btn-link danger"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
    </aside>

    <main class="content">
        <div class="mobile-header">
            <button class="btn-hamburger" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
            <h2>HD System</h2>
        </div>

        <header class="desktop-header">
            <div>
                <h1 id="page-title">Vis√£o Geral</h1>
                <p class="subtitle">Painel de controle conectado.</p>
            </div>
            <div class="date-badge" id="data-hoje"></div>
        </header>

        <div id="view-dashboard" class="view-section">
            <section class="kpi-container">
                <div class="card kpi kpi-clientes">
                    <div class="icon"><i class="fas fa-users"></i></div>
                    <div class="info"><h3>Total Clientes</h3><p id="kpi-total-clientes">...</p></div>
                </div>
                <div class="card kpi kpi-negoc">
                    <div class="icon"><i class="fas fa-comments-dollar"></i></div>
                    <div class="info"><h3>Em Negocia√ß√£o</h3><p id="kpi-negoc">0</p></div>
                </div>
                <div class="card kpi kpi-vencido">
                    <div class="icon"><i class="fas fa-exclamation-circle"></i></div>
                    <div class="info"><h3>Vencidos</h3><p id="kpi-vencidos">0</p></div>
                </div>
                <div class="card kpi kpi-alerta">
                    <div class="icon"><i class="fas fa-clock"></i></div>
                    <div class="info"><h3>A Vencer (30d)</h3><p id="kpi-alerta">0</p></div>
                </div>
                <div class="card kpi kpi-receita">
                    <div class="icon"><i class="fas fa-dollar-sign"></i></div>
                    <div class="info"><h3>Faturamento</h3><p id="kpi-faturamento">R$ 0,00</p></div>
                </div>
            </section>

            <section class="chart-container card">
                <div class="chart-header">
                    <h3>Desempenho Financeiro</h3>
                    <div class="chart-filters">
                        <button class="filter-btn" onclick="atualizarGrafico('1')">1M</button>
                        <button class="filter-btn" onclick="atualizarGrafico('3')">3M</button>
                        <button class="filter-btn active" onclick="atualizarGrafico('6')">6M</button>
                        <button class="filter-btn" onclick="atualizarGrafico('12')">1 Ano</button>
                        <button class="filter-btn" onclick="atualizarGrafico('60')">5 Anos</button>
                    </div>
                </div>
                <canvas id="financeChart"></canvas>
            </section>

            <section class="table-container">
                <div class="table-header"><h2>Pr√≥ximas Manuten√ß√µes</h2></div>
                <div class="table-responsive">
                    <table>
                        <thead><tr><th>Cliente</th><th>Status</th><th>Detalhe</th><th>WhatsApp</th><th>A√ß√£o</th></tr></thead>
                        <tbody id="tabela-dashboard"></tbody>
                    </table>
                </div>
                <div class="pagination-footer">
                    <button class="btn-page" id="btn-ant-dash" onclick="mudarPaginaDash(-1)" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="info-pag-dash" class="info-pag">Carregando...</span>
                    <button class="btn-page" id="btn-prox-dash" onclick="mudarPaginaDash(1)">Pr√≥xima <i class="fas fa-chevron-right"></i></button>
                </div>
            </section>
        </div>

        <div id="view-leads" class="view-section hidden">
            <section class="table-container">
                <div class="table-header">
                    <h2>Solicita√ß√µes do Site</h2>
                    <button class="btn-hist" onclick="carregarLeads()" style="background:var(--gray);"><i class="fas fa-sync"></i> Atualizar</button>
                </div>
                <div class="table-responsive">
                    <table class="table-leads">
                        <thead><tr><th>Data Pedido</th><th>Cliente</th><th>Servi√ßo Solicitado</th><th>A√ß√£o</th></tr></thead>
                        <tbody id="tabela-leads"></tbody>
                    </table>
                </div>
            </section>
        </div>

        <div id="view-vendas" class="view-section hidden">
            <section class="card form-section">
                <div class="form-header"><h3>Novo Registro</h3><p>Salve um servi√ßo realizado ou um or√ßamento aberto.</p></div>
                <form id="form-venda">
                    <div class="form-grid">
                        <div class="input-group">
                            <label>Cliente</label>
                            <input type="text" id="venda-nome" placeholder="Busque ou digite..." required list="lista-clientes-sugestao" onchange="autoPreencherDados()" autocomplete="off">
                            <datalist id="lista-clientes-sugestao"></datalist>
                        </div>
                        <div class="input-group"><label>WhatsApp</label><input type="tel" id="venda-tel" placeholder="119..." required></div>
                        <div class="input-group full-width"><label>Endere√ßo Completo</label><input type="text" id="venda-endereco" required></div>
                        <div class="input-group full-width"><label>Cidade</label><input type="text" id="venda-cidade" required></div>
                        <div class="input-group"><label>Data</label><input type="date" id="venda-data" required></div>
                        <div class="input-group">
                            <label>Tipo de Registro</label>
                            <select id="venda-tipo">
                                <option value="Or√ßamento">Or√ßamento / Cota√ß√£o</option>
                                <option value="Manuten√ß√£o Preventiva">Manuten√ß√£o Preventiva</option>
                                <option value="Manuten√ß√£o Corretiva">Manuten√ß√£o Corretiva</option>
                                <option value="Instala√ß√£o Nova">Instala√ß√£o Nova</option>
                                <option value="Visita T√©cnica">Visita T√©cnica</option>
                            </select>
                        </div>
                        <div class="input-group"><label>Valor (R$)</label><input type="number" id="venda-valor" step="0.01" placeholder="0.00" required></div>
                        <div class="input-group full-width"><label>Detalhes / Observa√ß√£o</label><input type="text" id="venda-obs" placeholder="Ex: Aguardando aprova√ß√£o..."></div>
                    </div>
                    <button type="submit" class="btn-primary">Salvar Registro</button>
                </form>
            </section>
        </div>

        <div id="view-clientes" class="view-section hidden">
            <section class="table-container">
                <div class="table-header with-search">
                    <h2>Base de Clientes</h2>
                    <div class="header-actions">
                        <button id="btn-excluir-massa" class="hidden-force" onclick="abrirModalExclusao()">
                            <i class="fas fa-trash-alt"></i> Excluir (<span id="lbl-qtd-excluir">0</span>)
                        </button>

                        <button id="btn-flex-disparo" class="hidden-force" onclick="prepararEnvioMassa()">
                            <i class="fab fa-whatsapp"></i> Disparar Oferta (0)
                        </button>

                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="busca-cliente" placeholder="Digite 'Flex' ou busque..." onkeyup="verificarFlex(this.value)">
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;">
                                    <input type="checkbox" id="check-all" onclick="selecionarTodos(this)" class="check-cliente">
                                </th>
                                <th>Nome</th>
                                <th>Endere√ßo</th>
                                <th>Data Atend.</th>
                                <th>A√ß√£o</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-clientes-base">
                            </tbody>
                    </table>
                </div>
                <div class="pagination-footer">
                    <button class="btn-page" id="btn-ant" onclick="mudarPagina(-1)" disabled><i class="fas fa-chevron-left"></i> Anterior</button>
                    <span id="info-paginacao" class="info-pag">Carregando...</span>
                    <button class="btn-page" id="btn-prox" onclick="mudarPagina(1)">Pr√≥xima <i class="fas fa-chevron-right"></i></button>
                </div>
            </section>
        </div>

        <div id="view-financeiro" class="view-section hidden">
            <section class="card form-section">
                <h3>Gerador de Recibo</h3>
                <form id="form-recibo" onsubmit="event.preventDefault(); gerarRecibo();">
                    <div class="form-grid">
                        <div class="input-group"><label>Nome</label><input type="text" id="rec-nome" required></div>
                        <div class="input-group"><label>Valor</label><input type="number" id="rec-valor" step="0.01" required></div>
                        <div class="input-group full-width"><label>Referente a</label><input type="text" id="rec-desc" required></div>
                    </div>
                    <button class="btn-secondary"><i class="fas fa-print"></i> Gerar Recibo</button>
                </form>
            </section>
        </div>
    </main>

    <div id="modal-historico" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-nome-cliente">Hist√≥rico</h2><button onclick="fecharModal('modal-historico')" class="btn-close"><i class="fas fa-times"></i></button></div>
            <div class="modal-body">
                <div class="client-details" style="margin-bottom:15px; background:var(--bg); padding:10px; border-radius:8px;">
                    <p style="margin-bottom:5px"><i class="fas fa-map-marker-alt" style="color:var(--accent)"></i> <span id="modal-endereco"></span></p>
                    <p><i class="fas fa-phone" style="color:var(--green)"></i> <span id="modal-telefone"></span></p>
                </div>
                <div class="client-stats"><div class="stat-box"><span class="label">Total Pago</span><span class="value" id="modal-total">R$ 0,00</span></div></div>
                <div class="timeline" id="modal-timeline"></div>
            </div>
        </div>
    </div>

    <div id="modal-recibo" class="modal-overlay hidden">
        <div class="modal-content paper-receipt">
            <div class="receipt-header"><h2>RECIBO</h2><p>HD AQUECEDORES</p></div>
            <div class="receipt-body">
                <p>Recebemos de <strong id="print-nome"></strong></p>
                <p>A quantia de <strong id="print-valor" style="font-size:1.4rem;"></strong></p>
                <p>Referente a: <span id="print-desc"></span></p>
                <p>Data: <span id="print-data"></span></p>
            </div>
            <div class="receipt-footer"><div class="signature">Assinatura</div></div>
            <div class="no-print" style="margin-top:20px; text-align:center;"><button onclick="window.print()" class="btn-primary">Imprimir</button><button onclick="fecharModal('modal-recibo')" class="btn-link danger">Fechar</button></div>
        </div>
    </div>

    <div id="modal-login" class="modal-overlay hidden">
        <div class="modal-content login-container">
            <div class="login-logo"><i class="fas fa-fire"></i></div>
            <h2>Acesso Restrito</h2>
            <p style="margin-bottom:20px; color:var(--text-light)">Entre com suas credenciais.</p>
            <form id="form-login">
                <div class="input-group full-width"><input type="email" id="login-email" placeholder="E-mail" required style="width:100%"></div>
                <div class="input-group full-width"><input type="password" id="login-senha" placeholder="Senha" required style="width:100%"></div>
                <button type="submit" class="btn-primary" style="width:100%">Entrar no Sistema</button>
            </form>
        </div>
    </div>

    <div id="modal-whatsapp" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2>Escolha a Mensagem</h2>
                <button onclick="fecharModal('modal-whatsapp')" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p id="zap-cliente-nome" style="margin-bottom: 20px; color: var(--text-light);">Cliente: ...</p>
                <div class="zap-grid">
                    <button onclick="enviarZap('cobranca')" class="btn-zap-opt"><i class="fas fa-file-invoice-dollar"></i> Cobran√ßa / Pix</button>
                    <button onclick="enviarZap('agendar')" class="btn-zap-opt"><i class="fas fa-calendar-check"></i> Agendar Manuten√ß√£o</button>
                    <button onclick="enviarZap('posvenda')" class="btn-zap-opt"><i class="fas fa-smile"></i> P√≥s-Venda</button>
                    <button onclick="enviarZap('orcamento')" class="btn-zap-opt"><i class="fas fa-comments-dollar"></i> Or√ßamento</button>
                </div>
            </div>
        </div>
    </div>

    <div id="modal-excluir" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <div class="modal-header">
                <h2 style="color: #ef4444;">Excluir Clientes</h2>
                <button onclick="fecharModal('modal-excluir')" class="btn-close"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 20px; color: var(--text);">Tem certeza que deseja excluir os clientes selecionados? Essa a√ß√£o n√£o pode ser desfeita.</p>
                <div style="display: flex; justify-content: center; gap: 10px;">
                    <button onclick="fecharModal('modal-excluir')" class="btn-link">Cancelar</button>
                    <button onclick="confirmarExclusao()" class="btn-primary" style="background-color: #ef4444; border: none;">Sim, Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="toast">Aviso</div>

    <script src="script.js"></script>

    <script>
        // --- 1. Detectar digita√ß√£o "Flex" ---
        function verificarFlex(texto) {
            const input = document.getElementById('busca-cliente');
            if (texto.toLowerCase() === 'flex') {
                mostrarToast("üöÄ Modo Flex Ativado! Agrupe os vizinhos.");
                input.style.borderColor = "#ef4444"; // Muda borda para vermelho
            } else {
                input.style.borderColor = "var(--border)";
            }
            // Chama a busca original do seu sistema
            if (typeof filtrarClientes === 'function') filtrarClientes(); 
        }

        // --- 3. Enviar Mensagem em Massa (Op√ß√£o A) ---
        function prepararEnvioMassa() {
            const selecionados = document.querySelectorAll('#tabela-clientes-base .check-cliente:checked');

            if (selecionados.length === 0) return;
            if (selecionados.length > 5) {
                alert("‚ö†Ô∏è Por seguran√ßa anti-spam, selecione no m√°ximo 5 clientes.");
                return;
            }

            // TEXTO DA ESTRAT√âGIA A (Isen√ß√£o de Taxa)
            const textoBase = "Ol√°, *[NOME]*! Tudo bem? O t√©cnico da *HD Aquecedores* estar√° no seu condom√≠nio amanh√£ atendendo um vizinho. Como j√° estaremos a√≠, consigo isentar 100% da taxa de visita para fazer a manuten√ß√£o do seu aquecedor. Quer que eu reserve um hor√°rio para voc√™?";

            let delay = 0;

            selecionados.forEach((check) => {
                const nome = check.dataset.nome.split(' ')[0]; // S√≥ o primeiro nome
                const telefone = check.dataset.tel;
                
                if(!telefone || telefone.length < 10) return;

                const msgFinal = textoBase.replace('[NOME]', nome);
                const link = `https://wa.me/55${limparTelefone(telefone)}?text=${encodeURIComponent(msgFinal)}`;

                // Abre janelas com intervalo de 1 segundo entre elas
                setTimeout(() => {
                    window.open(link, '_blank');
                }, delay);
                
                delay += 1000;
            });

            // Resetar ap√≥s envio
            setTimeout(() => {
                document.getElementById('check-all').checked = false;
                selecionados.forEach(c => c.checked = false);
                atualizarContadorFlex();
            }, delay + 500);
        }

        function limparTelefone(tel) {
            return tel.replace(/\D/g, '');
        }
    </script>
</body>
</html>